{% extends 'vertical.html' %}

{% load static i18n %}

{% block title %}Ground Staff Report - {{ train_name }}{% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href="{% static '/vendor/gridjs/theme/mermaid.min.css' %}">
<style>

    .toolbar {
        margin-bottom: 20px;
        text-align: right;
    }

    .btn-print {
        padding: 8px 16px;
        background-color: #0d6efd;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }

    .btn-print:hover {
        background-color: #0a58ca;
        color: white;
    }

    .btn-back {
        padding: 8px 16px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin-right: 10px;
    }

    .btn-back:hover {
        background-color: #5a6268;
        color: white;
    }

    .report-header {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 20px;
    }

    .train-name-side {
        font-size: 28px;
        font-weight: bold;
        color: #0d6efd;
        margin-bottom: 8px;
    }

    .station-details {
        font-size: 16px;
        color: #6c757d;
        margin: 0;
    }

    table.pdf-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    table.pdf-table th,
    table.pdf-table td {
        border: 1px solid #dee2e6;
        padding: 12px 8px;
        text-align: center;
        font-size: 14px;
    }

    table.pdf-table th {
        background-color: #eef2f9;
        font-weight: 600;
    }

    .print-header {
        display: none;
    }

    @media print {
        nav,
        aside,
        footer,
        .page-header,
        .topbar,
        .toolbar,
        .btn-back,
        .sidenav-menu {
            display: none !important;
        }

        body {
            margin: 0;
            font-size: 12px;
        }

        .pdf-table {
            font-size: 11px;
        }

        .report-header {
            display: none !important;
        }

        .print-header {
            display: block !important;
            text-align: center;
            margin-bottom: 20px;
        }

        .print-train-name-side {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .print-station-details {
            font-size: 14px;
            margin: 0;
        }
    }
</style>
{% endblock extra_css %}

{% block page_title %}
{% include 'partials/page-title.html' with title="Ground Staff" subtitle="Reports" %}
{% endblock page_title %}

{% block page_content %}

<div class="toolbar">
    <a href="{% url 'pages:dynamic_pages' template_name='tables-gridjs' %}" class="btn-back">‚Üê Back to Trains</a>
    <button class="btn-print" onclick="window.print()">üñ®Ô∏è Print Report</button>
</div>

<!-- Print Header (only visible when printing) -->
<div class="print-header">
    <div class="print-train-name-side" id="print-train-name-side">
        Loading...
    </div>
    <div class="print-station-details" id="print-station-details">
        Loading...
    </div>
</div>

<!-- Screen Header -->
<div class="report-header">
    <div class="train-name-side" id="train-name-side">
        Loading...
    </div>
    <div class="station-details" id="station-details">
        Loading...
    </div>
</div>

<!-- Summary Table -->
<table class="pdf-table">
    <thead>
        <tr>
            <th>Train Number</th>
            <th>Side</th>
            <th>Total Door Detected</th>
            <th>OTLI-SI</th>
            <th>OTLI-SM</th>
            <th>LI-SI</th>
            <th>LI-SM</th>
            <th>Broken-SI</th>
            <th>Broken-SM</th>
        </tr>
    </thead>
    <tbody>
        <tr id="summary-row">
            <td colspan="9" style="text-align: center; color: #6c757d;">Loading train data...</td>
        </tr>
    </tbody>
</table>

<!-- Detailed Door Information Table with Images -->
<table class="pdf-table">
    <thead>
        <tr>
            <th style="width: 15%;">Coach Position</th>
            <th style="width: 15%;">Door Number</th>
            <th style="width: 20%;">Wagon Number</th>
            <th style="width: 20%;">Marking</th>
            <th style="width: 30%;">Image</th>
        </tr>
    </thead>
    <tbody id="door-details-tbody">
        <tr>
            <td colspan="5" style="text-align: center; color: #6c757d; padding: 20px;">Loading door details...</td>
        </tr>
    </tbody>
</table>

<div style="margin-top: 40px; text-align: center; font-size: 12px; color: #6c757d;">
    <p>This report was generated automatically by the System</p>
    <p id="generation-info">Generated on: <span id="current-date"></span> at <span id="current-time"></span> &nbsp;|&nbsp; Station: <span id="station-name">Katihar Junction</span></p>
</div>

<script>
// Global variables for train data
let trainData = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const trainName = urlParams.get('name');
    const trainStatus = urlParams.get('status');
    const trainId = urlParams.get('id');

    // Start time updates
    setInterval(updateDateTime, 1000);
    updateDateTime();

    if (trainName && trainId) {
        // Fetch data from Flask API
        fetch(`http://127.0.0.1:5000/train-report?name=${encodeURIComponent(trainName)}&status=${trainStatus}&id=${trainId}`)
            .then(response => response.json())
            .then(data => {
                trainData = data;
                updateReportContent(data);
                document.title = `Ground Staff Report - ${data.train_name}`;
            })
            .catch(error => {
                console.error('Error fetching train report data:', error);
                loadFallbackData(trainName, trainStatus, trainId);
            });
    } else {
        loadFallbackData('Unknown Train', 'Unknown', '1');
    }
});

function updateDateTime() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    });
    const dateStr = now.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });

    // Update time elements
    const currentTimeEl = document.getElementById('current-time');
    const currentDateEl = document.getElementById('current-date');

    if (currentTimeEl) currentTimeEl.textContent = timeStr;
    if (currentDateEl) currentDateEl.textContent = dateStr;

    // Update headers with current time if we have train data
    if (trainData) {
        trainData.current_time = timeStr;
        trainData.current_date = dateStr;
        updateHeaderElements(trainData);
    }
}

function updateHeaderElements(data) {
    const trainNameSide = `Train Name: ${data.train_name} - Side: ${data.train_side}`;
    const stationDetails = `Station: ${data.station_name}    Time: ${data.current_time}    Date: ${data.current_date}`;

    // Update all header elements
    const trainNameSideElements = [
        document.getElementById('train-name-side'),
        document.getElementById('print-train-name-side')
    ];
    trainNameSideElements.forEach(el => {
        if (el) el.textContent = trainNameSide;
    });

    const stationDetailsElements = [
        document.getElementById('station-details'),
        document.getElementById('print-station-details')
    ];
    stationDetailsElements.forEach(el => {
        if (el) el.textContent = stationDetails;
    });
}

function updateReportContent(data) {
    // Update headers
    updateHeaderElements(data);

    // Update station name
    const stationNameEl = document.getElementById('station-name');
    if (stationNameEl) stationNameEl.textContent = data.station_name;

    // Update summary table
    const summaryRow = document.getElementById('summary-row');
    if (summaryRow) {
        summaryRow.innerHTML = `
            <td>${data.train_number || 'N/A'}</td>
            <td>${data.train_side || 'N/A'}</td>
            <td>${data.total_doors || 0}</td>
            <td>${data.otli_si || 0}</td>
            <td>${data.otli_sm || 0}</td>
            <td>${data.li_si || 0}</td>
            <td>${data.li_sm || 0}</td>
            <td>${data.broken_si || 0}</td>
            <td>${data.broken_sm || 0}</td>
        `;
    }

    // Update door details table
    const detailsTableBody = document.getElementById('door-details-tbody');
    if (detailsTableBody && data.door_details) {
        detailsTableBody.innerHTML = data.door_details.map(door => `
            <tr>
                <td>${door.position}</td>
                <td>${door.door_number}</td>
                <td>${door.wagon_number || '-'}</td>
                <td style="color: black; font-weight: normal;">${door.marking}</td>
                <td>
                    ${door.image ?
                        `<img src="${door.image}" alt="Train Bogie ${door.door_number}"
                             style="width: 120px; height: 80px; object-fit: cover; border-radius: 4px;
                                    border: 1px solid #dee2e6;">` :
                        `<div style="width: 120px; height: 80px; background-color: #f8f9fa;
                                    border: 1px dashed #dee2e6; display: flex; align-items: center;
                                    justify-content: center; border-radius: 4px; margin: 0 auto;">
                            <span style="font-size: 12px; color: #6c757d;">No Image</span>
                        </div>`
                    }
                </td>
            </tr>
        `).join('');
    }
}

function loadFallbackData(trainName, trainStatus, trainId) {
    const fallbackData = {
        train_name: trainName || 'Unknown Train',
        train_side: 'Right Side',
        train_number: `TN${trainId.padStart(3, '0')}`,
        station_name: 'Katihar Junction',
        current_time: new Date().toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        }),
        current_date: new Date().toLocaleDateString('en-GB', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        }),
        total_doors: 20,
        otli_si: 8,
        otli_sm: 6,
        li_si: 3,
        li_sm: 2,
        broken_si: 1,
        broken_sm: 0,
        door_details: Array.from({length: 20}, (_, i) => ({
            position: i + 1,
            door_number: i + 1,
            wagon_number: `WG${Math.floor(i/4 + 1).toString().padStart(3, '0')}`,
            marking: ['OTLI-SI', 'OTLI-SM', 'LI-SI', 'LI-SM', 'Broken-SI'][i % 5],
            image: i % 3 === 0 ? '' : `https://via.placeholder.com/120x80/007bff/ffffff?text=Door${i+1}`
        }))
    };

    trainData = fallbackData;
    updateReportContent(fallbackData);
}
</script>

{% endblock page_content %}