{% extends 'vertical.html' %}

{% load static i18n %}

{% block title %}Ground Staff Report - {{ train_name }}{% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href="{% static '/vendor/gridjs/theme/mermaid.min.css' %}">
<style>
    .toolbar {
        margin-bottom: 20px;
        text-align: right;
    }

    .btn-print {
        padding: 8px 16px;
        background-color: #0d6efd;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }

    .btn-print:hover {
        background-color: #0a58ca;
        color: white;
    }

    .btn-back {
        padding: 8px 16px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin-right: 10px;
    }

    .btn-back:hover {
        background-color: #5a6268;
        color: white;
    }

    .report-header {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 20px;
    }

    table.pdf-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    table.pdf-table th,
    table.pdf-table td {
        border: 1px solid #dee2e6;
        padding: 12px 8px;
        text-align: center;
        font-size: 14px;
    }

    table.pdf-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    /* Station Table custom spacing */
    table.station-table {
        width: 100%;
        table-layout: fixed;
    }

    table.station-table th:nth-child(1),
    table.station-table td:nth-child(1) {
        width: 240px;
    }

    table.station-table th:nth-child(2),
    table.station-table td:nth-child(2) {
        width: auto;
    }

    table.station-table th:nth-child(3),
    table.station-table td:nth-child(3) {
        width: 280px;
    }

    @media print {

        nav,
        aside,
        footer,
        .page-header,
        .topbar,
        .toolbar,
        .btn-back,
        .sidenav-menu {
            display: none !important;
        }

        body {
            margin: 0;
            font-size: 12px;
        }

        .pdf-table {
            font-size: 11px;
        }

        .report-header {
            display: none !important;
        }

        .print-header {
            display: block !important;
            text-align: center;
            margin-bottom: 20px;
        }
    }

    .print-header {
        display: none;
    }
</style>
{% endblock extra_css %}

{% block page_title %}
{% include 'partials/page-title.html' with title="Ground Staff" subtitle="Reports" %}
{% endblock page_title %}

{% block page_content %}

<div class="toolbar">
    <a href="{% url 'pages:dynamic_pages' template_name='tables-gridjs' %}" class="btn-back">‚Üê Back to Trains</a>
    <button class="btn-print" onclick="window.print()">üñ®Ô∏è Print Report</button>
</div>

<!-- Print Header (only visible when printing) -->
<div class="print-header">
    <h3 id="print-train-info">{{ train_name }} - Side: {{ train_side }}</h3>
    <p id="print-station-info">Station: {{ station_name }} Time: {{ current_time }} Date: {{ current_date }}</p>
</div>

<div class="report-header">
    <div style="text-align: center; margin-bottom: 20px;">
        <h3 style="color: #0d6efd; margin-bottom: 10px; font-size: 24px; font-weight: bold;" id="train-info-display">
            {{ train_name }} - Side: {{ train_side }}
        </h3>
        <p style="margin: 0; font-size: 14px; color: #6c757d;" id="station-info-display">
            Station: {{ station_name }} Time: {{ current_time }} Date: {{ current_date }}
        </p>
    </div>
</div>

<!-- Summary Table (Station Table with custom spacing) -->
<table class="pdf-table station-table">
    <thead>
        <tr>
            <th>Train Number</th>
            <th>Side</th>
            <th>Total Door Detected</th>
            <th>OTLI-SI</th>
            <th>OTLI-SM</th>
            <th>LI-SI</th>
            <th>LI-SM</th>
            <th>Broken-SI</th>
            <th>Broken-SM</th>
        </tr>
    </thead>
    <tbody>
        <tr id="summary-row">
            <td>{{ train_number }}</td>
            <td>{{ train_side }}</td>
            <td>{{ total_doors }}</td>
            <td>{{ otli_si }}</td>
            <td>{{ otli_sm }}</td>
            <td>{{ li_si }}</td>
            <td>{{ li_sm }}</td>
            <td>{{ broken_si }}</td>
            <td>{{ broken_sm }}</td>
        </tr>
    </tbody>
</table>

<!-- Detailed Door Information Table with Images -->
<table class="pdf-table">
    <thead>
        <tr>
            <th style="width: 15%;">Coach Position</th>
            <th style="width: 15%;">Door Number</th>
            <th style="width: 20%;">Wagon Number</th>
            <th style="width: 20%;">Marking</th>
            <th style="width: 30%;">Image</th>
        </tr>
    </thead>
    <tbody id="door-details-tbody">
        {% for door in door_details %}
        <tr>
            <td>{{ door.position }}</td>
            <td>{{ door.door_number }}</td>
            <td>{{ door.wagon_number|default:"-" }}</td>
            <td style="color: black; font-weight: normal;">{{ door.marking }}</td>
            <td>
                {% if door.image %}
                <img src="{{ door.image }}" alt="Train Bogie"
                    style="width: 120px; height: 80px; object-fit: cover; border-radius: 4px;">
                {% else %}
                <div
                    style="width: 120px; height: 80px; background-color: #f8f9fa; border: 1px dashed #dee2e6; display: flex; align-items: center; justify-content: center; border-radius: 4px; margin: 0 auto;">
                    <span style="font-size: 12px; color: #6c757d;">No Image</span>
                </div>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div style="margin-top: 40px; text-align: center; font-size: 12px; color: #6c757d;">
    <p>This report was generated automatically by the Train Inspection System</p>
    <p id="generation-info">Generated on: {{ current_date }} at {{ current_time }} | Station: {{ station_name }}</p>
</div>

<script>
    // Fetch dynamic data from Flask API and update the page
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const trainName = urlParams.get('name');
        const trainStatus = urlParams.get('status');
        const trainId = urlParams.get('id');

        // Update time every second
        setInterval(updateDateTime, 1000);

        if (trainName && trainId) {
            // Fetch data from Flask API
            fetch(`http://127.0.0.1:5000/train-report-data?name=${encodeURIComponent(trainName)}&status=${trainStatus}&id=${trainId}`)
                .then(response => response.json())
                .then(data => {
                    // Update page title
                    document.title = `Ground Staff Report - ${data.train_name}`;

                    // Update report content dynamically
                    updateReportContent(data);
                })
                .catch(error => {
                    console.error('Error fetching train report data:', error);
                    console.log('Using fallback data from Django template');
                });
        }

        // Initial time update
        updateDateTime();
    });

    function updateDateTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
        const dateStr = now.toLocaleDateString('en-GB', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });

        // Update time in all relevant elements
        const timeElements = document.querySelectorAll('#station-info-display, #print-station-info, #generation-info');
        timeElements.forEach(el => {
            if (el && el.id === 'station-info-display') {
                el.textContent = `Station: Katihar Junction    Time: ${timeStr}    Date: ${dateStr}`;
            } else if (el && el.id === 'print-station-info') {
                el.textContent = `Station: Katihar Junction    Time: ${timeStr}    Date: ${dateStr}`;
            } else if (el && el.id === 'generation-info') {
                el.textContent = `Generated on: ${dateStr} at ${timeStr} | Station: Katihar Junction`;
            }
        });
    }

    function updateReportContent(data) {
        // Update train info displays
        const trainInfo = `${data.train_name} - Side: ${data.train_side}`;
        const trainInfoElements = [
            document.getElementById('train-info-display'),
            document.getElementById('print-train-info')
        ];
        trainInfoElements.forEach(el => {
            if (el) el.textContent = trainInfo;
        });

        // Update station info
        const stationInfo = `Station: ${data.station_name}    Time: ${data.current_time}    Date: ${data.current_date}`;
        const stationInfoElements = [
            document.getElementById('station-info-display'),
            document.getElementById('print-station-info')
        ];
        stationInfoElements.forEach(el => {
            if (el) el.textContent = stationInfo;
        });

        // Update generation info
        const generationInfo = document.getElementById('generation-info');
        if (generationInfo) {
            generationInfo.textContent = `Generated on: ${data.current_date} at ${data.current_time} | Station: ${data.station_name}`;
        }

        // Update summary table
        const summaryRow = document.getElementById('summary-row');
        if (summaryRow) {
            summaryRow.innerHTML = `
            <td>${data.train_number}</td>
            <td>${data.train_side}</td>
            <td>${data.total_doors}</td>
            <td>${data.otli_si}</td>
            <td>${data.otli_sm}</td>
            <td>${data.li_si}</td>
            <td>${data.li_sm}</td>
            <td>${data.broken_si}</td>
            <td>${data.broken_sm}</td>
        `;
        }

        // Update detailed door information with images
        const detailsTableBody = document.getElementById('door-details-tbody');
        if (detailsTableBody && data.door_details) {
            detailsTableBody.innerHTML = data.door_details.map(door => `
            <tr>
                <td>${door.position}</td>
                <td>${door.door_number}</td>
                <td>${door.wagon_number || '-'}</td>
                <td style="color: black; font-weight: normal;">${door.marking}</td>
                <td>
                    ${door.image ?
                    `<img src="${door.image}" alt="Train Bogie" style="width: 120px; height: 80px; object-fit: cover; border-radius: 4px;">` :
                    `<div style="width: 120px; height: 80px; background-color: #f8f9fa; border: 1px dashed #dee2e6; display: flex; align-items: center; justify-content: center; border-radius: 4px; margin: 0 auto;">
                            <span style="font-size: 12px; color: #6c757d;">No Image</span>
                        </div>`
                }
                </td>
            </tr>
        `).join('');
        }
    }
</script>

{% endblock page_content %}